#!/usr/bin/env ruby

require 'optparse'
require 'methadone'
require 'compaa'
require 'sinatra'
require 'watir-webdriver'
require 'cgi'

class App
  include Methadone::Main
  include Methadone::CLILogging

  PORT = '7788'

  main do
    
    sinatra_pid = fork do
      user_project_path = Dir.pwd

      Dir.chdir(File.dirname(__FILE__))
      Dir.chdir("../")
      puts Dir.pwd

      `ln -s  #{user_project_path} #{Dir.pwd}/public`

      exec "thin start -p #{PORT}"
    end

    browser = Watir::Browser.new
    browser.window.resize_to 1368, 1200

    sleep 3

    Compaa::DifferenceImage.all.each do |difference_image|
      browser.goto "http://localhost:#{PORT}/?filepath=#{CGI::escape(difference_image.path)}"
      puts "Comparing: #{difference_image.path}"
      puts "Would you like to make this the reference image?"

      difference_image.create_reference_image if screenshot_approved?
    end

    Compaa::GeneratedImage.all.each do |generated_image|
      next if generated_image.has_reference_image?

      puts "Approving: #{generated_image.path}"
      generated_image.create_reference_image if screenshot_approved?
    end

    `kill -9 #{sinatra_pid}`

    browser.close

  end

  def self.screenshot_approved?
      STDIN.gets.chomp.downcase.start_with? 'y'
  end

  version Compaa::VERSION

  use_log_level_option

  go!
end
