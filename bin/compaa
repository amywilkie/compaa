#!/usr/bin/env ruby

require 'optparse'
require 'methadone'
require 'compaa'
require 'rack'
if ENV['TRAVIS'] == 'true'
  require 'watir-webdriver-fake'
else
  require 'watir-webdriver'
end
require 'cgi'

class App
  include Methadone::Main
  include Methadone::CLILogging

  PORT = 7788

  main do
    begin
      browser = Watir::Browser.new
      browser.window.resize_to 1368, 1200

      data = {
        :diff_images => Compaa::DifferenceImage.all.map(&:path),
        :new_images  => Compaa::GeneratedImage.all.reject(&:has_reference_image?)
      }

      app = Compaa::RackApp.new(data).app

      Thread.new do
        Rack::Handler::WEBrick.run app,
          :Port      => PORT,
          :Logger    => Compaa::NullObject.new,
          :AccessLog => [nil, nil]
      end

      browser.goto "http://localhost:#{PORT}/"

      sleep
    ensure
      browser.close
    end
  end

  version Compaa::VERSION

  use_log_level_option

  go!
end
