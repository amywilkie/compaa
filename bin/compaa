#!/usr/bin/env ruby

require 'optparse'
require 'methadone'
require 'compaa'
require 'gtk2'

class App
  include Methadone::Main
  include Methadone::CLILogging

  main do
    Compaa::DifferenceImage.all.each do |difference_image|
      puts "Comparing: #{difference_image.path}"
      puts "Would you like to make this the reference image?"

      difference_image.create_reference_image if screenshot_approved?
    end

    Compaa::GeneratedImage.all.each do |generated_image|
      next if generated_image.has_reference_image?

      puts "Approving: #{generated_image.path}"
      generated_image.create_reference_image if screenshot_approved?
    end
  end

  def self.screenshot_approved?
    dialog = Gtk::MessageDialog.new(nil, Gtk::Dialog::DESTROY_WITH_PARENT,
                                    Gtk::MessageDialog::QUESTION,
                                    Gtk::MessageDialog::BUTTONS_YES_NO,
                                    "Would you like to make this file the reference shot?")
    approved = dialog.run == -8
    dialog.destroy

    approved
  end

  version Compaa::VERSION

  use_log_level_option

  go!
end
